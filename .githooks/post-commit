
#!/usr/bin/env bash
# Post-commit hook: builds and publishes `build-output` to wphub-dist in background.
# This runs async so commits aren't blocked; logs go to .git/hooks/post-commit.log

set -e

# Trigger build+sync when relevant source files changed in the commit.
# We consider changes under `src/`, `public/`, config files, or top-level html/css/js that affect the build.
CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD || true)
echo "$CHANGED" | sed -n '1,200p'
if ! echo "$CHANGED" | grep -E '^(src/|public/|index.html|package.json|vite.config.js|tailwind.config.js|postcss.config.js|src/|assets/|styles/|App.jsx|main.jsx)' >/dev/null 2>&1; then
  echo "Post-commit: no relevant source changes; skipping build/publish."
  exit 0
fi

echo "Post-commit: detected relevant source changes, building and syncing dist in background..."

# Run build and sync in background, capture output
( 
  echo "Starting sync at $(date)"
  npm run build -- --outDir build-output && 
  echo "Build finished at $(date)"
  bash scripts/sync-build-to-dist.sh || echo "sync-build-to-dist.sh exited with code $?"
 ) > .git/hooks/post-commit.log 2>&1 &

exit 0
